# ApexSim Tests

Unit tests for the ApexSim game client (Godot/C#).

## Running Tests

```bash
cd game-godot/ApexSim.Tests
dotnet test
```

## Test Coverage

### ProceduralTerrainTests

Tests for MessagePack deserialization of procedural terrain data generated by the Rust server.

- **CanDeserializeTestProceduralTerrain**: Verifies that the test procedural track can be deserialized
- **CanDeserializeEnvironmentData**: Validates environment preset data deserialization
- **HeightmapSamplingWorks**: Tests heightmap bilinear interpolation
- **AllRealTracksWithTerrainCanBeDeserialized**: Ensures all real track terrain files can be loaded
- **MessagePackAttributesAreCorrect**: Validates MessagePack attributes for array-based serialization

## Important Notes

### MessagePack Serialization Format

The Rust server uses `rmp_serde::to_vec()` which serializes structs as **arrays**, not maps. This is different from `rmp_serde::to_vec_named()` which uses map-based encoding.

To match this in C#, we use:
- `[MessagePackObject]` attribute on classes (NOT `[MessagePackObject(true)]`)
- `[Key(0)]`, `[Key(1)]`, etc. attributes on properties to define array order
- `StandardResolver` instead of `ContractlessStandardResolver`

The field order in C# classes **must exactly match** the struct field order in Rust.

## Adding New Tests

When adding tests that read files from the content directory:

1. Use relative paths that navigate up from the test bin directory:
   ```csharp
   string path = Path.Combine("..", "..", "..", "..", "..", "content", "tracks", "file.yaml");
   path = Path.GetFullPath(path);
   ```

2. Always check if the file exists before attempting to read it
3. Use the same MessagePackSerializerOptions as production code
